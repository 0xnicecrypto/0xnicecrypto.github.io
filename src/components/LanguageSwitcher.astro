---
import { locales, localeNames, defaultLocale, type Locale, getLocalizedPath } from "@/i18n";

interface Props {
	class?: string;
}

const { class: className } = Astro.props;

// Get current locale from URL
const currentPath = Astro.url.pathname;
const currentLocale = locales.find(
	(loc) => currentPath.startsWith(`/${loc}/`) || currentPath === `/${loc}`
) || defaultLocale;

// Generate path for each locale
const getPathForLocale = (locale: Locale): string => {
	return getLocalizedPath(currentPath, locale);
};
---

<div class:list={["relative", className]}>
	<language-switcher>
		<button
			aria-expanded="false"
			aria-haspopup="listbox"
			class="flex items-center gap-1.5 rounded-md p-1.5 text-sm font-medium transition-colors hover:bg-accent/10 hover:text-accent"
			id="language-toggle"
			type="button"
		>
			<svg
				aria-hidden="true"
				class="h-4 w-4"
				fill="none"
				stroke="currentColor"
				stroke-width="1.5"
				viewBox="0 0 24 24"
				xmlns="http://www.w3.org/2000/svg"
			>
				<path
					d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418"
					stroke-linecap="round"
					stroke-linejoin="round"
				></path>
			</svg>
			<span class="hidden sm:inline">{localeNames[currentLocale]}</span>
			<svg
				aria-hidden="true"
				class="h-3 w-3 transition-transform duration-200"
				fill="none"
				id="language-arrow"
				stroke="currentColor"
				stroke-width="1.5"
				viewBox="0 0 24 24"
				xmlns="http://www.w3.org/2000/svg"
			>
				<path d="M19.5 8.25l-7.5 7.5-7.5-7.5" stroke-linecap="round" stroke-linejoin="round"></path>
			</svg>
		</button>

		<ul
			class="absolute right-0 top-full z-50 mt-1 hidden min-w-[120px] rounded-md border border-border bg-global-bg p-1 shadow-lg"
			id="language-menu"
			role="listbox"
		>
			{
				locales.map((locale) => (
					<li role="option" aria-selected={locale === currentLocale}>
						<a
							href={getPathForLocale(locale)}
							class:list={[
								"block rounded px-3 py-2 text-sm transition-colors",
								locale === currentLocale
									? "bg-accent/10 text-accent font-medium"
									: "hover:bg-accent/5 hover:text-accent",
							]}
						>
							{localeNames[locale]}
						</a>
					</li>
				))
			}
		</ul>
	</language-switcher>
</div>

<script>
	class LanguageSwitcher extends HTMLElement {
		#isOpen = false;
		#button: HTMLButtonElement | null = null;
		#menu: HTMLElement | null = null;
		#arrow: HTMLElement | null = null;

		connectedCallback() {
			this.#button = this.querySelector("#language-toggle");
			this.#menu = this.querySelector("#language-menu");
			this.#arrow = this.querySelector("#language-arrow");

			this.#button?.addEventListener("click", this.#toggle.bind(this));
			document.addEventListener("click", this.#handleClickOutside.bind(this));
			document.addEventListener("keydown", this.#handleKeydown.bind(this));
		}

		disconnectedCallback() {
			document.removeEventListener("click", this.#handleClickOutside.bind(this));
			document.removeEventListener("keydown", this.#handleKeydown.bind(this));
		}

		#toggle() {
			this.#isOpen = !this.#isOpen;
			this.#updateState();
		}

		#close() {
			this.#isOpen = false;
			this.#updateState();
		}

		#updateState() {
			if (this.#isOpen) {
				this.#menu?.classList.remove("hidden");
				this.#button?.setAttribute("aria-expanded", "true");
				this.#arrow?.classList.add("rotate-180");
			} else {
				this.#menu?.classList.add("hidden");
				this.#button?.setAttribute("aria-expanded", "false");
				this.#arrow?.classList.remove("rotate-180");
			}
		}

		#handleClickOutside(event: MouseEvent) {
			if (!this.contains(event.target as Node)) {
				this.#close();
			}
		}

		#handleKeydown(event: KeyboardEvent) {
			if (event.key === "Escape" && this.#isOpen) {
				this.#close();
			}
		}
	}

	customElements.define("language-switcher", LanguageSwitcher);
</script>
