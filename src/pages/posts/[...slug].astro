---
import { getCollection } from 'astro:content';
import PostLayout from '../../layouts/PostLayout.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  
  // Group posts by locale
  const postsByLocale: Record<string, typeof allPosts> = {};
  allPosts.forEach(post => {
    const locale = post.data.locale || 'en';
    if (!postsByLocale[locale]) postsByLocale[locale] = [];
    postsByLocale[locale].push(post);
  });
  
  // Generate paths for each locale
  const paths = [];
  for (const [locale, posts] of Object.entries(postsByLocale)) {
    const sortedPosts = posts
      .filter(post => !post.data.draft)
      .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
    
    sortedPosts.forEach((post, index) => {
      paths.push({
        params: { slug: post.slug },
        props: {
          post,
          prevPost: index < sortedPosts.length - 1 ? sortedPosts[index + 1] : null,
          nextPost: index > 0 ? sortedPosts[index - 1] : null,
        },
      });
    });
  }
  
  return paths;
}

const currentLocale = Astro.currentLocale || 'en';
const { post, prevPost, nextPost } = Astro.props;
const { Content } = await post.render();
const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';

const t = {
  en: {
    readOther: "Read other posts"
  },
  zh: {
    readOther: "阅读其他文章"
  }
};

const content = t[currentLocale as keyof typeof t];
---

<PostLayout {...post.data}>
  <Content />
  
  <div class="pagination">
    <div class="pagination__title">
      <span class="pagination__title-h">{content.readOther}</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      {prevPost && (
        <>
          <a href={`${base}posts/${prevPost.slug}/`} class="button inline prev">
            &lt; [<span class="button__text">{prevPost.data.title}</span>]
          </a>
          {prevPost && nextPost && <span>::</span>}
        </>
      )}
      {nextPost && (
        <a href={`${base}posts/${nextPost.slug}/`} class="button inline next">
          [<span class="button__text">{nextPost.data.title}</span>] &gt;
        </a>
      )}
    </div>
  </div>
</PostLayout>
